---
#-----------------------|DOCUMENTATION|-----------------------#
# @descr: Defining remote access users
# @fonts: 
#-------------------------------------------------------------#

# ISSUE NOTICE:
- name: "SUB TASK : [ config-remote-access-users.yml ]"
  debug:
    msg: "START: Defining remote access users..."

- name: "Output: List the remote access users that will be added"
  vars:
    var_user: "{{ item.user }}"
  debug:
    msg: "RESULT: --User: {{ var_user }}"
  with_items:
    - "{{ security_remote_access_users | list }}"
  when: (security_remote_access_users | list | length > 0)

- name: "Add or edit user on the system"
  user: 
    name: "{{ item.user }}"
    comment: "{{ item.comment | default('Remote access user generated by Ansible') }}"
    create_home: "{{ item.create_home | default(true) }}"
    home: "{{ item.home | default('/home/' + item.user) }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    groups: "{{ item.groups | default([]) }}"
    state: "{{ item.state | default('present') }}"
  with_items:
    - "{{ security_remote_access_users | list }}"
  when: (security_remote_access_users | list | length > 0)

- name: "Add authorized SSH keys to a given user"
  vars:
    var_user: "{{ item.0.user }}"
    var_authorized_key: "{{ item.1 }}"
  authorized_key:
    user: "{{ var_user }}"
    key: "{{ var_authorized_key }}"
  with_subelements:
    - "{{ security_remote_access_users | rejectattr('ssh_authorized_keys', 'undefined') | list }}"
    - "ssh_authorized_keys"
  ignore_errors: true
  when: (security_remote_access_users | list | length > 0)

- name: "Add privilege to user in (/etc/sudoers.d/*)"
  vars:
    var_user: "{{ item.user }}"
    var_privilege: "{{ item.privilege | default(false) }}"
  template:
    src: "../templates/sudoers.j2"
    dest: "/etc/sudoers.d/{{ var_user }}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - "{{ security_remote_access_users | list }}"
  when: (security_remote_access_users | list | length > 0) and (var_privilege == true)
