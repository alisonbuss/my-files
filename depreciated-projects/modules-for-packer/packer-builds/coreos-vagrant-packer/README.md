## Project generated through [coreos-packer](https://github.com/alisonbuss/coreos-packer/).
# Documentation:
## [Packer Modules] used to generate the Packer Template.
##### Directory of Packer Modules: "./packer-modules"
```text
./packer-modules
├── builders
├── post-processors
├── provisioners
└── variables

4 directories

```
 
## New Model for Packer.
##### ./packer-new-model/coreos-vagrant.json 
```bash
{
    "packer_template": {
        "description": "CoreOS image for a Vagrant platform.",
        "variables": {
            "vagrant_cpus": "2", 
            "vagrant_memory": "2048",
            "vagrant_disk_size": "33666"
        },
        "list_variables": [
            "/variables/vars-global.json",
            "/variables/vars-coreos.json",
            "/variables/vars-vagrant.json"
        ],
        "builders": [
            "/builders/vagrant.json"
        ],
        "provisioners": [
            "/provisioners/install-python.json",
            "/provisioners/install-docker.json",
            "/provisioners/install-docker-compose.json",
            "/provisioners/install-etcd.json",
            "/provisioners/install-flannel.json",
            "/provisioners/install-kubernetes.json",
            "/provisioners/provide-basic-security.json",
            "/provisioners/provide-clean-image.json"
        ],
        "post_processors": [
            "/post-processors/vagrant-box.json"
        ],
        "min_packer_version": "1.1.3"
    }
}
```
 
## Files generated by the New Model Packer.
```text
./packer-builds/coreos-vagrant-packer
├── coreos-stable-1576.5.0.iso
├── files
│   ├── ignitions
│   │   ├── keys-to-underworld-for-azure.json
│   │   ├── keys-to-underworld-for-digitalocean.json
│   │   ├── keys-to-underworld-for-ec2.json
│   │   ├── keys-to-underworld-for-gce.json
│   │   ├── keys-to-underworld-for-packet.json
│   │   ├── keys-to-underworld-for-virtualbox.json
│   │   └── keys-to-underworld.json
│   └── vagrant_insecure_private_key
├── packer-template
│   ├── coreos-vagrant-template.json
│   ├── coreos-vagrant-template-min.json
│   ├── vars-coreos.json
│   ├── vars-custom-variables.json
│   ├── vars-global.json
│   └── vars-vagrant.json
├── README.md
└── start-packer.sh

3 directories, 17 files

```
 
## Custom Variables of the New Model Packer:
#### vars-custom-variables.json
##### ./packer-builds/coreos-vagrant-packer/packer-template/vars-custom-variables.json
```json
{
  "vagrant_cpus": "2",
  "vagrant_memory": "2048",
  "vagrant_disk_size": "33666"
}
```
 
## List Variables of the New Model Packer:
##### ./packer-modules/variables/vars-global.json 
```json
{
    "global_working_directory": ".",
    "global_build_path": "{{user `global_working_directory`}}/packer-builds/coreos-vagrant-packer",
    "global_provisioner_path": "{{user `global_working_directory`}}/pre-provision"
}
```
 
##### ./packer-modules/variables/vars-coreos.json 
```json
{
    "os_name": "coreos",
    "os_release": "stable",
    "os_version": "1576.5.0",

    "os_iso_url": "http://{{user `os_release`}}.release.core-os.net/amd64-usr/{{user `os_version`}}/coreos_production_iso_image.iso",
    "os_iso_checksum_type": "SHA512",
    "os_iso_checksum": "5d236b4fed05b782919f2f4e8f478d9e920e18461eed94e177fb41e77cc40fe241253c3d22de636a766e80bb340435ed4f83b64aa6dceb8e211d7962251ada7e",
    
    "os_img_aws": "ami-44a03c22",
    "os_img_google": "coreos-stable",
    "os_img_digitalocean": "coreos-stable",

    "os_user_data_name": "keys-to-underworld",
    "os_user_data_path": "/files/ignitions/"
}
```
 
##### ./packer-modules/variables/vars-vagrant.json 
```json
{
    "vagrant_vm_name": "vm-coreos-packer",
    "vagrant_cpus": "1", 
    "vagrant_memory": "512",
    "vagrant_disk_size": "20000",
    "vagrant_insecure_private_key": "/files/vagrant_insecure_private_key"
}
```
 
 
## Builders of the New Model Packer:
##### ./packer-modules/builders/vagrant.json 
```json
{
    "type": "virtualbox-iso",
        
    "vm_name": "{{user `vagrant_vm_name`}}",
    "iso_checksum": "{{user `os_iso_checksum`}}",
    "iso_checksum_type": "{{user `os_iso_checksum_type`}}",
    "iso_url": "http://{{user `os_release`}}.release.core-os.net/amd64-usr/{{user `os_version`}}/coreos_production_iso_image.iso",
    "iso_target_path": "{{user `global_build_path`}}/coreos-{{user `os_release`}}-{{user `os_version`}}.iso", 
    "guest_os_type": "Linux26_64",
    
    "hard_drive_interface": "sata",
    "disk_size": "{{user `vagrant_disk_size`}}",
    "vboxmanage": [
        ["modifyvm", "{{.Name}}", "--memory", "{{user `vagrant_memory`}}"],
        ["modifyvm", "{{.Name}}", "--cpus", "{{user `vagrant_cpus`}}"]
    ],
    "http_directory": "{{user `global_build_path`}}",

    "headless": "false",
    "guest_additions_mode": "disable",
    "output_directory": "{{user `global_build_path`}}/packer-vm-cache",
    
    "boot_wait": "33s",
    "boot_command": [
        "sudo -i;<enter>",
        "systemctl stop sshd.socket;<enter>",
        "wget http://{{ .HTTPIP }}:{{ .HTTPPort }}{{user `os_user_data_path`}}{{user `os_user_data_name`}}-for-virtualbox.json;<enter>",
        "cat {{user `os_user_data_name`}}-for-virtualbox.json;<enter>",
        "coreos-install -d /dev/sda -C {{ user `os_release` }} -i {{user `os_user_data_name`}}-for-virtualbox.json;<enter>",
        "sleep 3s;<enter>",
        "reboot;<enter>"
    ],  
    
    "communicator": "ssh",
    "ssh_port": 22,
    "ssh_username": "packer",
    "ssh_private_key_file": "{{user `global_build_path`}}{{user `vagrant_insecure_private_key`}}",
    "ssh_timeout": "33m",

    "shutdown_command": "sudo -S shutdown -P now"
}
```
 
 
## Provisioners of the New Model Packer:
##### ./packer-modules/provisioners/install-python.json 
```json
{
    "type": "shell",
    "environment_vars" : [
       
    ],
    "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
    "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-python.sh"
    ]
}
```
 
##### ./packer-modules/provisioners/install-docker.json 
```json
{
    "type": "shell",
    "environment_vars" : [
       
    ],
    "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
    "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-docker.sh"
    ]
}
```
 
##### ./packer-modules/provisioners/install-docker-compose.json 
```json
{
    "type": "shell",
    "environment_vars" : [
       
    ],
    "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
    "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-docker-compose.sh"
    ]
}
```
 
##### ./packer-modules/provisioners/install-etcd.json 
```json
{
    "type": "shell",
    "environment_vars" : [
       
    ],
    "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
    "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-etcd.sh"
    ]
}
```
 
##### ./packer-modules/provisioners/install-flannel.json 
```json
{
    "type": "shell",
    "environment_vars" : [
       
    ],
    "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
    "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-flannel.sh"
    ]
}
```
 
##### ./packer-modules/provisioners/install-kubernetes.json 
```json
{
    "type": "shell",
    "environment_vars" : [
       
    ],
    "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
    "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-kubernetes.sh"
    ]
}
```
 
##### ./packer-modules/provisioners/provide-basic-security.json 
```json
{
    "type": "shell",
    "environment_vars" : [
       
    ],
    "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
    "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/provide-basic-security.sh"
    ]
}
```
 
##### ./packer-modules/provisioners/provide-clean-image.json 
```json
{
    "type": "shell",
    "environment_vars" : [
       
    ],
    "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
    "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/provide-clean-image.sh"
    ]
}
```
 
 
## Post-Processors of the New Model Packer:
##### ./packer-modules/post-processors/vagrant-box.json 
```json
{
    "type": "vagrant",
    "compression_level": "6",
    "output": "{{user `global_build_path`}}/coreos-{{user `os_release`}}-{{user `os_version`}}.box"
}
```
 
 
## Packer Template generated through the New Model Packer:
#### coreos-vagrant-template.json
##### ./packer-builds/coreos-vagrant-packer/packer-template/coreos-vagrant-template.json
```json
{
  "description": "CoreOS image for a Vagrant platform.",
  "builders": [
    {
      "type": "virtualbox-iso",
      "vm_name": "{{user `vagrant_vm_name`}}",
      "iso_checksum": "{{user `os_iso_checksum`}}",
      "iso_checksum_type": "{{user `os_iso_checksum_type`}}",
      "iso_url": "http://{{user `os_release`}}.release.core-os.net/amd64-usr/{{user `os_version`}}/coreos_production_iso_image.iso",
      "iso_target_path": "{{user `global_build_path`}}/coreos-{{user `os_release`}}-{{user `os_version`}}.iso",
      "guest_os_type": "Linux26_64",
      "hard_drive_interface": "sata",
      "disk_size": "{{user `vagrant_disk_size`}}",
      "vboxmanage": [
        [
          "modifyvm",
          "{{.Name}}",
          "--memory",
          "{{user `vagrant_memory`}}"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--cpus",
          "{{user `vagrant_cpus`}}"
        ]
      ],
      "http_directory": "{{user `global_build_path`}}",
      "headless": "false",
      "guest_additions_mode": "disable",
      "output_directory": "{{user `global_build_path`}}/packer-vm-cache",
      "boot_wait": "33s",
      "boot_command": [
        "sudo -i;<enter>",
        "systemctl stop sshd.socket;<enter>",
        "wget http://{{ .HTTPIP }}:{{ .HTTPPort }}{{user `os_user_data_path`}}{{user `os_user_data_name`}}-for-virtualbox.json;<enter>",
        "cat {{user `os_user_data_name`}}-for-virtualbox.json;<enter>",
        "coreos-install -d /dev/sda -C {{ user `os_release` }} -i {{user `os_user_data_name`}}-for-virtualbox.json;<enter>",
        "sleep 3s;<enter>",
        "reboot;<enter>"
      ],
      "communicator": "ssh",
      "ssh_port": 22,
      "ssh_username": "packer",
      "ssh_private_key_file": "{{user `global_build_path`}}{{user `vagrant_insecure_private_key`}}",
      "ssh_timeout": "33m",
      "shutdown_command": "sudo -S shutdown -P now"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "environment_vars": [],
      "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-python.sh"
      ]
    },
    {
      "type": "shell",
      "environment_vars": [],
      "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-docker.sh"
      ]
    },
    {
      "type": "shell",
      "environment_vars": [],
      "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-docker-compose.sh"
      ]
    },
    {
      "type": "shell",
      "environment_vars": [],
      "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-etcd.sh"
      ]
    },
    {
      "type": "shell",
      "environment_vars": [],
      "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-flannel.sh"
      ]
    },
    {
      "type": "shell",
      "environment_vars": [],
      "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/install-kubernetes.sh"
      ]
    },
    {
      "type": "shell",
      "environment_vars": [],
      "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/provide-basic-security.sh"
      ]
    },
    {
      "type": "shell",
      "environment_vars": [],
      "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "scripts": [
        "{{user `global_provisioner_path`}}/shell-script/provide-clean-image.sh"
      ]
    }
  ],
  "post-processors": [
    {
      "type": "vagrant",
      "compression_level": "6",
      "output": "{{user `global_build_path`}}/coreos-{{user `os_release`}}-{{user `os_version`}}.box"
    }
  ],
  "min_packer_version": "1.1.3"
}

```
 
## Execution script Packer CLI, generated through the New Model Packer:
#### start-packer.sh
##### ./packer-builds/coreos-vagrant-packer/start-packer.sh
```bash
#!/bin/bash
function StartPacker {
    local params="$@";
    local coreos_release="stable";
    local coreos_version="1576.5.0";
    local coreos_url_digests="http://${coreos_release}.release.core-os.net/amd64-usr/${coreos_version}/coreos_production_iso_image.iso.DIGESTS";
    local coreos_iso_checksum_type="SHA512";
    local coreos_iso_checksum=$(wget -qO- "${coreos_url_digests}" | grep "coreos_production_iso_image.iso" | awk '{ print length, $1 | "sort -rg"}' | awk 'NR == 1 { print $2 }');
    local working_directory=".";
    local build_path="./packer-builds/coreos-vagrant-packer";
    local provisioner_path="./pre-provision";
    local template_path="./packer-builds/coreos-vagrant-packer/packer-template";
    local template_file="${template_path}/coreos-vagrant-template-min.json";
    __run_packer() {
        # FONT: https://www.packer.io/docs/templates/user-variables.html#from-a-file
        packer "$@" \
			-var-file="${template_path}/vars-global.json" \
			-var-file="${template_path}/vars-coreos.json" \
			-var-file="${template_path}/vars-vagrant.json" \
            -var-file="${template_path}/vars-custom-variables.json" \
            -var "os_release=${coreos_release}" \
            -var "os_version=${coreos_version}" \
            -var "os_iso_checksum_type=${coreos_iso_checksum_type}" \
            -var "os_iso_checksum=${coreos_iso_checksum}" \
            -var "global_working_directory=${working_directory}" \
            -var "global_build_path=${build_path}" \
            -var "global_provisioner_path=${provisioner_path}" \
            "${template_file}";
    }
    case $params in
        validate) { __run_packer $params; };;
        inspect)  { packer inspect "${template_file}"; };;
        *build*)  { __run_packer $params; };;
        *)        { packer $params; };;
    esac
}
StartPacker "$@";
exit 0;

```
 
